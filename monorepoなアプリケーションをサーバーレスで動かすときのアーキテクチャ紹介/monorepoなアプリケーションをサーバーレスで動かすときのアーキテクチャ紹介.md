---
marp: true
theme: default
class: invert
paginate: true
footer: Written by [@tachibanayu24](https://twitter.com/tachibanayu24)
---

# ğŸŒ Monorepo ãªã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ã§å‹•ã‹ã™ã¨ãã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ç´¹ä»‹

<style scoped>
section { 
    font-size: 28px; 
}
</style>

2023.07.12
tatti ([@tachibanayu24](https://twitter.com/tachibanayu24))

---

# ã¯ãªã™ã“ã¨

- æœ€è¿‘ serverless ã§ monorepo ãªã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é–‹ç™ºã—ã¦ã„ã¦ãã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã‚’ç´¹ä»‹ã™ã‚‹
  - æ§‹æˆã‚’è€ƒãˆãŸã‘ã©çµå±€å®Ÿç¾ã—ãªã‹ã£ãŸã®ã§ä¾›é¤Šã—ãŸã„æ„å›³
- ä¸»ã«ã‚¤ãƒ³ãƒ•ãƒ©ã ã‘ã©å®Ÿè£…ã‚‚å°‘ã—

---

# è¦ä»¶

- EC ã‚µã‚¤ãƒˆ
  - ç®¡ç†ç”»é¢ã¨ã‚·ãƒ§ãƒƒãƒ—
  - shopify åˆ©ç”¨
- ç®¡ç†ç”»é¢ã‚„ staging ã¯èªè¨¼ãŒå¿…è¦
- å°‚ä»»ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãŒã„ãªã„ã®ã§ã‚¤ãƒ³ãƒ•ãƒ©ç®¡ç†ã®ã‚³ã‚¹ãƒˆã‚’æŠ‘ãˆãŸã„
- ã¨ã¯ã„ãˆç›£è¦–ã¯ã—ãŸã„

---

# æ§‹æˆå›³

![Architecture](./architecture.png)

---

# ãƒã‚¤ãƒ³ãƒˆç´¹ä»‹

## Cloud IAP(Identity-Aware Proxy)

ä»Šå›ã¯ç®¡ç†è€…ã¨ã—ã¦èªè¨¼ãŒå¿…è¦ãªå ´åˆã¯ Load Balancing ã—ã¦ IAP ã‚’çµŒç”±ã™ã‚‹æ§‹æˆã§çœã‚¨ãƒã€‚

- IAP(ã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£èªè­˜å‹ãƒ—ãƒ­ã‚­ã‚·)ã¨ã¯ã€åˆ©ç”¨è€…ã¨ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®èªè¨¼åŸºç›¤ã‚„èªå¯æƒ…å ±ãªã©ã‚’ä»²ä»‹ã™ã‚‹ãƒ—ãƒ­ã‚­ã‚·
- Cloud IAP ã¯ãƒ•ãƒ«ãƒãƒãƒ¼ã‚¸ãƒ‰ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·ã¨ã—ã¦åˆ©ç”¨ã§ãã‚‹
  - ã‚‚ã¡ã‚ã‚“ Bastion(è¸ã¿å°)ã‚µãƒ¼ãƒãƒ¼çš„ãªå½¹å‰²ã‚‚æ‹…ãˆã‚‹
  - Google ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®èªè¨¼ã‚’åˆ©ç”¨ã§ãã‚‹
  - ãƒ–ãƒ©ã‚¦ã‚¶ã«èªè¨¼æƒ…å ±ãŒãªã„å ´åˆã¯ Google ã®ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ãƒ­ãƒ¼ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã‚Œã‚‹

---

# ãƒã‚¤ãƒ³ãƒˆç´¹ä»‹

## Cloud Logging

ååˆ†ãªæ©Ÿèƒ½ã‚’å‚™ãˆãŸãƒ­ã‚°ç®¡ç†ã€‚

- Error Reporting
  - ä¾‹å¤–ã‚’åˆ†æã—ã¦æ„å‘³å˜ä½ã®ã‚°ãƒ«ãƒ¼ãƒ—ã«é›†ç´„ã§ãã‚‹
- ã‚¢ãƒ©ãƒ¼ãƒˆæ©Ÿèƒ½ã‚‚ã‚ã‚Šä½¿ã„ã‚„ã™ã„
- Audit Log
  - ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«é–‰ã˜ãšãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ç®¡ç†ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã‚’é–¢ã—
  - ã‚„ã£ã¦ãŠãã«è¶Šã—ãŸã“ã¨ã¯ãªã„

---

# ãƒã‚¤ãƒ³ãƒˆç´¹ä»‹

## Cloud Monitoring

ã‚¤ãƒ³ãƒ•ãƒ©ç›£è¦–ã€‚

- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£è¦–
  - ã‚„ã°ã„ã¨ãã¯ã‚¢ãƒ©ãƒ¼ãƒˆã‚’æŒ™ã’ã‚‰ã‚Œã‚‹
- å¯ç”¨æ€§ã€å¥å…¨æ€§
  - ç›®æ¨™ SLA ã‚’è¨­å®šã—ã¦ç›£è¦–å¯èƒ½
- ãƒ­ã‚°é€šçŸ¥
  - ä»»æ„ã®æ¡ä»¶ã®ãƒ­ã‚°ã‚’æ¤œçŸ¥ã—ãŸã‚‰ slack ã«é€šçŸ¥ã§ãã‚‹

---

# ãƒã‚¤ãƒ³ãƒˆç´¹ä»‹

## Firebase Authentication

ä»Šå› Shopify ã«å•†å“ãƒ‡ãƒ¼ã‚¿ãªã©è–„ãä¿å­˜ã—ã¦ã€ãã‚Œä»¥å¤–ã¯ Firestore ã‚„ Firebase ã§ãƒ‡ãƒ¼ã‚¿ã‚’ç®¡ç†ã™ã‚‹äºˆå®šã ã£ãŸã€‚

- ã‚«ã‚¹ã‚¿ãƒ ã‚¯ãƒ¬ãƒ¼ãƒ 
  - ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®å±æ€§ã‚’ã‚«ã‚¹ã‚¿ãƒ ã—å®šç¾©ã§ãã‚‹
  - ã‚µãƒ–ã‚¹ã‚¯æœ‰åŠ¹ä¸­ï¼Ÿ
  - shopify ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ ID ã¯ï¼Ÿ
  - ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼Ÿå†…éƒ¨ã®ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼Ÿ

---

# Remix ã®å®Ÿè£…ç´¹ä»‹

## Remix Server Context ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º

```ts
const handleRequest = createRequestHandler({
  build: remixBuild,
  mode: process.env.NODE_ENV,
  getLoadContext: (): AppLoadContext => ({
    session, // sessionã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
    storefront, // shopify sdkã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
    customerAccount, // shopify API
    cart, // ã‚«ãƒ¼ãƒˆã®ä¸­èº«
    env, // ç’°å¢ƒå¤‰æ•°
  }),
});
```

---

## Remix Server Context ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º

```ts
export async function loader({ context }: LoaderFunctionArgs) {
  const { storefront } = context;

  const allProducts = storefront.query(ALL_PRODUCTS_QUERY);

  ...

  return defer({ ... });
}
```
